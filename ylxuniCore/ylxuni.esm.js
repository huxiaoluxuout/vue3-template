function e(e,t){return Object.prototype.toString.call(e).replace(/\[object (\w+)\]/,"$1").toLowerCase()===t}function t(e){if("object"!=typeof e||null===e)throw new TypeError("Target must be an object");return new Proxy(e,{get:(e,t,n)=>Reflect.get(e,t,n),set:(e,t,n,o)=>Reflect.set(e,t,n,o)})}function n(e=uni,t){return{ylxEventBus:new r(e),ylxNextPage:new a(e),ylxMustLogIn:new s(e,t)}}const o=new class{constructor(){this.eventListeners=new Map}on(e,t){if("function"!=typeof t)throw new Error(`${t} 必须是一个函数`);this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}once(e,t){if("function"!=typeof t)throw new Error(`${t} 必须是一个函数`);const n=(...o)=>{t(...o),this.off(e,n)};this.on(e,n)}emit(e,...t){let n,o,r;if("string"==typeof e)n=e;else{if("object"!=typeof e)throw new Error("Options 必须是字符串或对象");n=e.event,o=e.handler,r=e.source}const a=this.eventListeners.get(n);if(!a)return;const s={args:t,source:r};if(o){for(const e of a)if(e.name===o){e(s);break}}else a.forEach((e=>e(s)))}off(e,t){if(t){if("function"==typeof t){const n=this.eventListeners.get(e);n&&n.delete(t)}}else this.eventListeners.delete(e)}clear(){this.eventListeners.clear()}};class r{static platform=null;constructor(e){r.platform=e}static NAVIGATION_TYPES={NAVIGATE_TO:"navigateTo",SWITCH_TAB:"switchTab"};static eventBusSet=new Set;static defaultGlobalCallback=({args:e,source:t})=>console.log("AppEvent",{args:e,source:t});static defaultThenCallback=()=>{console.log("thenCallback")};onGlobal(e=r.defaultGlobalCallback){o.on("AppEvent",e),o.on("GLOBAL_PAGES_EVENT",r.handlerListener)}static handlerListener({args:e,source:t}){let[{navigationType:n,targetPath:o,isNavigationEnabled:a,options:s,sourceName:c}]=e;const{path:i,query:l,delimiter:u}=r.parseUrl(o);r.sendTargetPage(i,t,s,c),r.handleNavigation(n,i,l,u,s,a)}static sendTargetPage(e,t,n,a){r.eventBusSet.has(e)?o.emit({event:e,source:a||t},n):o.once("CURRENT_PAGE_EVENT"+e,(()=>(r.eventBusSet.add(e),o.emit({event:e,source:a||t},n))))}static handleNavigation(e,t,n,o,a,s){if(!s)return;if(e!==r.NAVIGATION_TYPES.NAVIGATE_TO&&e!==r.NAVIGATION_TYPES.SWITCH_TAB)return void console.error(`导航路径：${JSON.stringify(r.NAVIGATION_TYPES)}`);const c=e===r.NAVIGATION_TYPES.NAVIGATE_TO?`${t}${n}${o}currentRoute=${t}`:t;r.platform[e]({url:c,fail:e=>console.error("Navigation Error:",e)})}async emit({targetPath:e,options:t={},source:n=""},a=!1,s=r.NAVIGATION_TYPES.NAVIGATE_TO){const c=await r.getRoute(),i="object"==typeof t?Object.assign({fromPage:c},t):t;return new Promise((t=>{i.thenCallback=t,o.emit({event:"GLOBAL_PAGES_EVENT",source:c,handler:"handlerListener"},{navigationType:s,targetPath:e,isNavigationEnabled:a,options:i,sourceName:n})}))}async emitGlobal(e={},t=""){const n=await r.getRoute(),a="object"==typeof e?Object.assign({fromPage:n},e):e;return new Promise((e=>{a.thenCallback=e,o.emit({event:"AppEvent",source:t||n},a)}))}static getRoute(){const e=getCurrentPages(),t="/"+e[e.length-1].route;return Promise.resolve(t)}on(e){"function"==typeof e&&r.getRoute().then((t=>{r.eventBusSet.has(t)||r.eventBusSet.add(t),o.on(t,e),o.emit("CURRENT_PAGE_EVENT"+t)}))}static parseUrl(e){const t=e.startsWith("/")?e:"/"+e,[n,o]=t.split("?");return{path:n,query:o?"?"+o:"",delimiter:o?"&":"?"}}}class a{static platform=null;constructor(e){a.platform=e}useNextPage(n=1,o=10){function r(){T.page=i,T.pageSize=l}function s(e){f=!0,u=!1,r(),h(),"function"==typeof e&&e()}function c(){T.page>1&&!u&&h()}let i=n,l=o,u=!1,f=!1;const{setFun:g,addFun:p,invokeAllFn:h}=function(){let e=[],t=[];return{addFun:(e,...n)=>{t.some((t=>t.func===e&&t.args.length===n.length))||t.push({func:e,args:n})},setFun:(t,...n)=>{e=[{func:t,args:n}]},invokeAllFn:function(){const n=t.concat(e);for(;n.length>0;){const{func:e,args:t}=n.pop();e(...t)}}}}(),T=t({page:i,pageSize:l});r();let m=0;return{mixinReachBottomPullDownRefresh:{onLoad(){r()},onReachBottom(){c()},onPullDownRefresh(){s(),m=setTimeout((()=>{a.platform.stopPullDownRefresh()}),2500)}},reachBottomHandler:c,pageInfoProxy:T,setFun:g,addFun:p,invokeAllFn:h,reload:s,dataHandler:function({data:t=[],resData:n=[]},o=!1){return a.platform.stopPullDownRefresh(),clearTimeout(m),e(t,"array")?(e(n,"array")||(console.warn("没有数据要返回空数组！！！"),n=[]),f&&(t=[],o=!0,f=!1),o?(T.page+=1,t.concat(n)):1===T.page?n:u?t:(u=!0,t.concat(n))):n}}}}class s{static platform=null;static loginObject={login:!1};constructor(e,n){s.platform=e,n&&(s.loginObject=n(s.loginObject)),this.loginProxyObject=t(s.loginObject)}static agreeToLogIn(){s.platform.navigateTo({url:"/pages/login/login",fail(e){console.error("platform:fail",e)}})}static onError(){s.platform.showModal({title:"登录后，获取完整功能",success:function(e){e.confirm?s.agreeToLogIn():e.cancel&&s.notAgreeToLogIn()}})}setLoginToken({tokenKey:e,tokenData:t},n){this.loginProxyObject.login=!0,s.platform.setStorage({key:e,data:t,success:function(){"function"==typeof n&&n()}})}unSetLoginToken(e,t="token"){this.loginProxyObject.login=!1,s.platform.removeStorage({key:t,success:function(){"function"==typeof e&&e()}})}interceptMastLogIn({onLoggedIn:e=()=>{},onNotLoggedIn:n=s.onError,cancel:o=()=>{},confirm:r=s.agreeToLogIn}){const{createInterceptor:a}=function(e){const n=t(e);return{proxyObject:n,createInterceptor:function({onError:t,onSuccess:o}){if("function"==typeof t){if("function"==typeof o)return function(...r){const a=Object.keys(e)[0];n[a]?o(...r):t()};console.error(`${o}: 2 必须是函数`)}else console.error(`${t}: 1 必须是函数`)}}}(s.loginObject);return s.agreeToLogIn=r,s.notAgreeToLogIn=o,a({onSuccess:e,onError:n})}}export{n as default};
