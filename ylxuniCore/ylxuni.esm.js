function e(e,t){const n=Object.prototype.toString.call(e).replace(/\[object (\w+)\]/,"$1").toLowerCase();return t?n===t:n}function t(e){return new Proxy(e,{get:(e,t,n)=>Reflect.get(e,t,n),set:(e,t,n,o)=>Reflect.set(e,t,n,o)})}function n(t,n,o){e(t,"object")&&e(t.setData,"function")&&t.setData({[n]:o})}function o(e=uni,t){return{ylxEventBus:new s(e),ylxNextPage:new r(e,t),ylxMustLogIn:new c(e,t)}}const a=new class{constructor(){this.eventListeners=new Map}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,{}),this.eventListeners.get(e)[t.name]=t}once(e,t){const n=(...o)=>{t(...o),this.off(e,n)};this.on(e,n)}emit(t,...n){let o,a,s;e(t,"string")?o=t:e(t,"object")&&(o=t.event,a=t.handler,s=t.source);const r=this.eventListeners.get(o);if(!r)return;const c={args:n,source:s};if(a){const e=r[a];e&&e(c)}else Object.values(r).forEach((e=>e(c)))}off(t,n,o){if(n){if(e(n,"function")){const e=this.eventListeners.get(t);e&&(o?Object.keys(e).forEach((t=>{delete e[t]})):delete e[n.name])}}else this.eventListeners.delete(t)}clear(){this.eventListeners.clear()}};class s{static platform=null;constructor(e){s.platform=e}static eventBusSet=new Set;static defaultGlobalCallback=()=>({});onGlobal(e=s.defaultGlobalCallback){a.on("AppEvent",e),a.on("GLOBAL_PAGES_EVENT",s.handlerListener)}static handlerListener({args:e,source:t}){let[{targetPath:n,options:o,sourceName:a}]=e;const{path:r}=function(e){const t=e.startsWith("/")?e:"/"+e,[n,o]=t.split("?");return{path:n,query:o?"?"+o:"",delimiter:o?"&":"?"}}(n);s.sendTargetPage(r,t,o,a)}static sendTargetPage(e,t,n,o){s.eventBusSet.has(e)?a.emit({event:e,source:o||t},n):a.once("CURRENT_PAGE_EVENT"+e,(()=>(s.eventBusSet.add(e),a.emit({event:e,source:o||t},n))))}async emit({targetPath:t,options:n={},source:o="",prevPage:r=!1}){const{currentRoute:c,prevPageRoute:i}=await s.getRoute();r&&i&&(t=i);const l=e(n,"object")?Object.assign({fromPage:c},n):n;return new Promise((e=>{l.thenCallback=e,a.emit({event:"GLOBAL_PAGES_EVENT",source:c,handler:"handlerListener"},{targetPath:t,options:l,sourceName:o})}))}async emitGlobal(t={},n=""){const{currentRoute:o}=await s.getRoute(),r=e(t,"object")?Object.assign({fromPage:o},t):t;return new Promise((e=>{r.thenCallback=e,a.emit({event:"AppEvent",source:n||o},r)}))}static getRoute(){const e=getCurrentPages();let t=null;e.length>=2&&(t="/"+e[e.length-2].route);const n="/"+e[e.length-1].route;return Promise.resolve({currentRoute:n,prevPageRoute:t})}on(t){e(t,"function")&&s.getRoute().then((({currentRoute:e})=>{s.eventBusSet.has(e)||s.eventBusSet.add(e),a.on(e,t),a.emit("CURRENT_PAGE_EVENT"+e)}))}off(t,{targetPath:n,del:o=!1}){e(n,"undefined")?s.getRoute().then((({currentRoute:e})=>{a.off(e,t,o)})):a.off(n,t,o)}clear(){a.clear()}}class r{static platform=null;static pageInfo={page:1,pageSize:10};static loadingObj={loading:!0};constructor(e,n){r.platform=e,n&&(r.loadingObj=n(r.loadingObj)),this.loadingProxyObject=t(r.loadingObj)}useNextPage(o={page:1,pageSize:10},a,s="loading"){function c(){P.page=r.pageInfo.page,P.pageSize=r.pageInfo.pageSize}function i(t){y=!0,m=!1,x=!0,u.loadingProxyObject.loading=!0,n(a,s,!0),c(),b(),e(t,"function")&&t(P)}function l(){P.page>1&&x&&b()}const u=this,{setFn:g,addFn:f,invokeAllFn:p}=function(){let e=[],t=[];return{addFn:(e,...n)=>{t.some((t=>t.func===e&&t.args.length===n.length))||t.push({func:e,args:n})},setFn:(t,...n)=>{e=[{func:t,args:n}]},invokeAllFn:function(){const n=t.concat(e);for(;n.length>0;){const{func:e,args:t}=n.pop();e(...t)}}}}(),h=f,d=g,b=p;e(o,"object")||(o={page:1,pageSize:10}),o.page||o.pageSize||(o={page:1,pageSize:10});let y=!1,m=!1,x=!0;r.pageInfo={...o};const P=t(o);let v=0;return{ylxMixins:{onLoad(){c()},onReachBottom(){l()},onPullDownRefresh(){i(),v=setTimeout((()=>{r.platform.stopPullDownRefresh()}),2500)}},ylxPageInfo:P,ylxReachBottom:l,ylxSetFn:d,ylxAddFn:h,ylxInvokeFn:b,ylxRefresh:i,ylxSetData:function({data:t=[],resData:o=[]}={},c=0){if(r.platform.stopPullDownRefresh(),clearTimeout(v),u.loadingProxyObject.loading=!1,n(a,s,!1),!e(t,"array"))return o;e(t,"array")&&!e(o,"array")&&(o=[]),y&&(t.length=0,y=!1);let i=c>t.length+o.length;if(1===P.page)return i&&(P.page+=1),o;if(i)return P.page+=1,t.concat(o);if(m){x=!1;let e=(P.page-1)*P.pageSize,n=t.length-e;return t.splice(e,n,...o),t}return m=!0,t.concat(o)},ylxSetInv:function(e){d(e),b()}}}}class c{static platform=null;static loginObject={login:!1};static wxThis=null;static wxLoginKey="login";constructor(e,n){c.platform=e,n&&(c.loginObject=n(c.loginObject)),this.loginProxyObject=t(c.loginObject)}wxSetLogin(e,t="login"){c.wxThis=e,c.wxLoginKey=t}setLoginToken({tokenKey:t,tokenData:o},a){this.loginProxyObject.login=!0,n(c.wxThis,c.wxLoginKey,!0),c.platform.setStorage({key:t,data:o,success:function(){e(a,"function")&&a()}})}unSetLoginToken(t,o="token"){this.loginProxyObject.login=!1,n(c.wxThis,c.wxLoginKey,!1),c.platform.removeStorage({key:o,success:function(){e(t,"function")&&t()}})}intercept({success:e=()=>{},fail:n=()=>{}}={}){const{createInterceptor:o}=function(e){const n=t(e);return{proxyObject:n,createInterceptor:function({onError:t,onSuccess:o}){return function(...a){const s=Object.keys(e)[0];n[s]?o(...a):t()}}}}(c.loginObject);return o({onSuccess:e,onError:n})}}export{o as default};
