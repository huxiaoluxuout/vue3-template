function e(e,t){const n=Object.prototype.toString.call(e).replace(/\[object (\w+)\]/,"$1").toLowerCase();return t?n===t:n}function t(e){return new Proxy(e,{get:(e,t,n)=>Reflect.get(e,t,n),set:(e,t,n,o)=>Reflect.set(e,t,n,o)})}function n(e=uni,t){return{ylxEventBus:new a(e),ylxNextPage:new r(e),ylxMustLogIn:new s(e,t)}}const o=new class{constructor(){this.eventListeners=new Map}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,{}),this.eventListeners.get(e)[t.name]=t}once(e,t){const n=(...o)=>{t(...o),this.off(e,n)};this.on(e,n)}emit(t,...n){let o,a,r;if(e(t,"string"))o=t;else{if(!e(t,"object"))throw new Error("第一个参数必须是字符串或对象");o=t.event,a=t.handler,r=t.source}const s=this.eventListeners.get(o);if(!s)return;const i={args:n,source:r};if(a){const e=s[a];e&&e(i)}else Object.values(s).forEach((e=>e(i)))}off(t,n,o){if(n){if(e(n,"function")){const e=this.eventListeners.get(t);e&&(o?Object.keys(e).forEach((t=>{delete e[t]})):delete e[n.name])}}else this.eventListeners.delete(t)}clear(){this.eventListeners.clear()}};class a{static platform=null;constructor(e){a.platform=e}static NAVIGATION_TYPES={NAVIGATE_TO:"navigateTo",SWITCH_TAB:"switchTab"};static eventBusSet=new Set;static defaultGlobalCallback=({args:e,source:t})=>console.log("AppEvent",{args:e,source:t});onGlobal(e=a.defaultGlobalCallback){o.on("AppEvent",e),o.on("GLOBAL_PAGES_EVENT",a.handlerListener)}static handlerListener({args:e,source:t}){let[{navigationType:n,targetPath:o,isNavigationEnabled:r,options:s,sourceName:i}]=e;const{path:c,query:l,delimiter:u}=function(e){const t=e.startsWith("/")?e:"/"+e,[n,o]=t.split("?");return{path:n,query:o?"?"+o:"",delimiter:o?"&":"?"}}(o);a.sendTargetPage(c,t,s,i),a.handleNavigation(n,c,l,u,s,r)}static sendTargetPage(e,t,n,r){a.eventBusSet.has(e)?o.emit({event:e,source:r||t},n):o.once("CURRENT_PAGE_EVENT"+e,(()=>(a.eventBusSet.add(e),o.emit({event:e,source:r||t},n))))}static handleNavigation(e,t,n,o,r,s){if(!s)return;if(e!==a.NAVIGATION_TYPES.NAVIGATE_TO&&e!==a.NAVIGATION_TYPES.SWITCH_TAB)return void console.error(`导航路径：${JSON.stringify(a.NAVIGATION_TYPES)}`);const i=e===a.NAVIGATION_TYPES.NAVIGATE_TO?`${t}${n}${o}currentRoute=${t}`:t;a.platform[e]({url:i,fail:e=>console.error("Navigation Error:",e)})}async emit({targetPath:e,options:t={},source:n=""},r=!1,s=a.NAVIGATION_TYPES.NAVIGATE_TO){const i=await a.getRoute(),c="object"==typeof t?Object.assign({fromPage:i},t):t;return new Promise((t=>{c.thenCallback=t,o.emit({event:"GLOBAL_PAGES_EVENT",source:i,handler:"handlerListener"},{navigationType:s,targetPath:e,isNavigationEnabled:r,options:c,sourceName:n})}))}async emitGlobal(e={},t=""){const n=await a.getRoute(),r="object"==typeof e?Object.assign({fromPage:n},e):e;return new Promise((e=>{r.thenCallback=e,o.emit({event:"AppEvent",source:t||n},r)}))}static getRoute(){const e=getCurrentPages(),t="/"+e[e.length-1].route;return Promise.resolve(t)}on(e){"function"==typeof e&&a.getRoute().then((t=>{a.eventBusSet.has(t)||a.eventBusSet.add(t),o.on(t,e),o.emit("CURRENT_PAGE_EVENT"+t)}))}off(t,{targetPath:n,del:r=!1}){e(n,"undefined")?a.getRoute().then((e=>{o.off(e,t,r)})):o.off(n,t,r)}clear(){o.clear()}}class r{static platform=null;static pageInfo={page:1,pageSize:10};constructor(e){r.platform=e}useNextPage(n={page:1,pageSize:10}){function o(){d.page=r.pageInfo.page,d.pageSize=r.pageInfo.pageSize,T.loading=!0}function a(t){p=!0,h=!1,o(),f(),e(t,"function")&&t(d)}function s(){d.page>1&&!h&&f()}const{setFun:i,addFun:c,invokeAllFn:l}=function(){let e=[],t=[];return{addFun:(e,...n)=>{t.some((t=>t.func===e&&t.args.length===n.length))||t.push({func:e,args:n})},setFun:(t,...n)=>{e=[{func:t,args:n}]},invokeAllFn:function(){const n=t.concat(e);for(;n.length>0;){const{func:e,args:t}=n.pop();e(...t)}}}}(),u=c,g=i,f=l;e(n,"object")||(n={page:1,pageSize:10}),n.page||n.pageSize||(n={page:1,pageSize:10});let p=!1,h=!1;r.pageInfo={...n};const d=t(n),T=t({loading:!0});let m=0;return{ylxMixins:{onLoad(){o()},onReachBottom(){s()},onPullDownRefresh(){a(),m=setTimeout((()=>{r.platform.stopPullDownRefresh()}),2500)}},ylxPageInfo:d,ylxLoadingInfo:T,ylxReachBottom:s,ylxSetFun:g,ylxAddFun:u,ylxInvokeFn:f,ylxRefresh:a,ylxSetData:function({data:t=[],resData:n=[]},o=!1){if(r.platform.stopPullDownRefresh(),clearTimeout(m),T.loading=!1,!e(t,"array"))return n;if(e(t,"array")&&!e(n,"array")&&(console.error(`${n} must be array !!!`),n=[]),p&&(t=[],p=!1),1===d.page)return n;if(o)return d.page+=1,t.concat(n);if(h){let e=(d.page-1)*d.pageSize,o=n.length;return t.splice(e,o,...n)}return h=!0,t.concat(n)}}}}class s{static platform=null;static loginObject={login:!1};constructor(e,n){s.platform=e,n&&(s.loginObject=n(s.loginObject)),this.loginProxyObject=t(s.loginObject)}setLoginToken({tokenKey:t,tokenData:n},o){this.loginProxyObject.login=!0,s.platform.setStorage({key:t,data:n,success:function(){e(o,"function")&&o()}})}unSetLoginToken(t,n="token"){this.loginProxyObject.login=!1,s.platform.removeStorage({key:n,success:function(){e(t,"function")&&t()}})}intercept({success:e=()=>{},fail:n=()=>{}}){const{createInterceptor:o}=function(e){const n=t(e);return{proxyObject:n,createInterceptor:function({onError:t,onSuccess:o}){return function(...a){const r=Object.keys(e)[0];n[r]?o(...a):t()}}}}(s.loginObject);return o({onSuccess:e,onError:n})}}export{n as default};
