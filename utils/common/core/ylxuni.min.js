!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).ylxuni=t()}(this,(function(){"use strict";function e(e,t){return Object.prototype.toString.call(e).replace(/\[object (\w+)\]/,"$1").toLowerCase()===t}function t(e){if("object"!=typeof e||null===e)throw new TypeError("Target must be an object");return new Proxy(e,{get:(e,t,n)=>Reflect.get(e,t,n),set:(e,t,n,o)=>Reflect.set(e,t,n,o)})}function n(n=1,o=10){function r(){p.page=c,p.pageSize=l}function s(e){f=!0,u=!1,r(),E(),"function"==typeof e&&e()}function i(){p.page>1&&!u&&E()}let a=uni;wx&&(a=wx);let c=n,l=o,u=!1,f=!1;const{setFun:d,addFun:g,invokeAllFn:E}=function(){let e=[],t=[];return{addFun:(e,...n)=>{t.some((t=>t.func===e&&t.args.length===n.length))||t.push({func:e,args:n})},setFun:(t,...n)=>{e=[{func:t,args:n}]},invokeAllFn:function(){const n=t.concat(e);for(;n.length>0;){const{func:e,args:t}=n.pop();e(...t)}}}}(),p=t({page:c,pageSize:l});r();let A=0;
// #endif
return{
// #ifndef VUE3
handleScrollAndRefresh:{onLoad(){r()},onReachBottom(){i()},onPullDownRefresh(){s(),A=setTimeout((()=>{a.stopPullDownRefresh()}),2500)}},
// #endif
// #ifdef VUE3
reachBottomHandler:i,
// #endif
pageInfoProxy:p,setFun:d,addFun:g,invokeAllFn:E,reload:s,dataHandler:function({data:t=[],resData:n=[]},o=!1){return a.stopPullDownRefresh(),clearTimeout(A),e(t,"array")?(e(n,"array")||(console.warn("没有数据要返回空数组！！！"),n=[]),f&&(t=[],o=!0,f=!1),o?(p.page+=1,t.concat(n)):1===p.page?n:u?t:(u=!0,t.concat(n))):n}
// #ifndef VUE3
}}
// #ifdef APP-PLUS
function o(){console.log("默认回调函数")}const r=new class{constructor(){this.listeners=new Map}on(e,t){if("function"!=typeof t)throw new Error(t+"必须是一个函数");this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}once(e,t){if("function"!=typeof t)throw new Error(t+"必须是一个函数");const n=(...o)=>{t(...o),this.off(e,n)};this.on(e,n)}emit(e,...t){let n,o,r;if("string"==typeof e)n=e;else{if("object"!=typeof e)throw new Error("Options必须是字符串或对象");n=e.event,o=e.handler,r=e.source}const s=this.listeners.get(n);if(s)if(o){const e=[...s].find((e=>e.name===o));e&&e({args:t,source:r})}else s.forEach((e=>e({args:t,source:r})))}off(e,t){if(t){if("function"==typeof t){const n=this.listeners.get(e);n&&n.delete(t)}}else this.listeners.set(e,new Set)}clear(){this.listeners.clear()}};class s{static platform=null;constructor(e){s.platform=e,this.onGlobal=this.handleRegisterGlobalEvent,this.emitGlobal=this.handleSendGlobal,this.emit=this.handleEmit,this.on=this.handleOn}static NAVIGATION_TYPES={NAVIGATE_TO:"navigateTo",SWITCH_TAB:"switchTab"};static eventBusSet=new Set;static defaultGlobalCallback=({args:e,source:t})=>console.log("AppEvent",{args:e,source:t});handleRegisterGlobalEvent(e=s.defaultGlobalCallback){r.on("AppEvent",e),r.on("GLOBAL_PAGES_EVENT",s.handlerListener)}static handlerListener({args:e,source:t}){let[{navigationType:n,targetPath:o,isNavigationEnabled:r,options:i,sourceName:a}]=e;const{path:c,query:l,delimiter:u}=s.parseUrl(o);s.sendTargetPage(c,t,i,a),s.handleNavigation(n,c,l,u,i,r)}static sendTargetPage(e,t,n,o){s.eventBusSet.has(e)?r.emit({event:e,source:o||t},n):r.once("CURRENT_PAGE_EVENT"+e,(()=>(s.eventBusSet.add(e),r.emit({event:e,source:o||t},n))))}static handleNavigation(e,t,n,o,r,i){if(!i)return;if(e!==s.NAVIGATION_TYPES.NAVIGATE_TO&&e!==s.NAVIGATION_TYPES.SWITCH_TAB)return void console.error(`导航路径：${JSON.stringify(s.NAVIGATION_TYPES)}`);const a=e===s.NAVIGATION_TYPES.NAVIGATE_TO?`${t}${n}${o}currentRoute=${t}`:t;s.platform[e]({url:a,fail:e=>console.error("Navigation Error:",e)})}async handleEmit({targetPath:e,options:t={},source:n=""},o=!1,i=s.NAVIGATION_TYPES.NAVIGATE_TO){const a=await s.getRoute(),c="object"==typeof t?Object.assign({fromPage:a},t):t;r.emit({event:"GLOBAL_PAGES_EVENT",source:a,handler:"handlerListener"},{navigationType:i,targetPath:e,isNavigationEnabled:o,options:c,sourceName:n})}async handleSendGlobal(e={},t=""){const n=await s.getRoute(),o="object"==typeof e?Object.assign({fromPage:n},e):e;r.emit({event:"AppEvent",source:t||n},o)}static getRoute(){const e=getCurrentPages(),t="/"+e[e.length-1].route;return Promise.resolve(t)}handleOn(e){"function"==typeof e&&s.getRoute().then((t=>{s.eventBusSet.has(t)||(s.eventBusSet.add(t),r.on(t,e),r.emit("CURRENT_PAGE_EVENT"+t))}))}static parseUrl(e){const t=e.startsWith("/")?e:"/"+e,[n,o]=t.split("?");return{path:n,query:o?"?"+o:"",delimiter:o?"&":"?"}}}class i{static targetLogin={login:!1};static platform=null;constructor(e){i.platform=e,this.loginProxyObject=t(i.targetLogin)}static onError(){i.platform.showModal({title:"登录后，获取完整功能",success:function(e){e.confirm?console.log("用户点击确定"):e.cancel&&console.log("用户点击取消")}})}setLoginToken({tokenKey:e,tokenData:t},n){this.loginProxyObject.login=!0,i.platform.setStorage({key:e,data:t,success:function(){"function"==typeof n&&n()}})}updateLogin(e){this.loginProxyObject.login=!0,"function"==typeof e&&e()}unSetLoginToken(e,t){this.loginProxyObject.login=!1,i.platform.removeStorage({key:e,success:function(){"function"==typeof t&&t()}})}interceptMastLogIn({onSuccess:e,onError:n=i.onError}){const{createInterceptor:o}=function(e){const n=t(e);return{proxyObject:n,createInterceptor:function({onError:t,onSuccess:o}){if("function"==typeof t){if("function"==typeof o)return function(...r){const s=Object.keys(e)[0];n[s]?o(...r):t()};console.error(`${o}: 必须是函数`)}else console.error(`${t}: 必须是函数`)}}}(i.targetLogin);return o({onSuccess:e,onError:n})}}const a=(e,t)=>{(e=>{let t=[e];return Array.isArray(e)&&(t=e),new Promise((e=>{plus.android.requestPermissions(t,(function(t){t.deniedAlways.length?e(0):t.deniedPresent.length?e(1):t.granted.length&&e(2)}))}))})(e).then((n=>{2===n||1===n?t(!0):0===n&&(l(e),t(!1))}))},c=(e,t=!1)=>{const n={ACCESS_FINE_LOCATION:{authorize:"android.permission.ACCESS_FINE_LOCATION",title:"定位权限说明",describe:"便于您检索附近的客户，请您确认授权，否则无法使用该功能"},CALL_PHONE:{authorize:"android.permission.CALL_PHONE",title:"拨打电话权限说明",describe:"便于您使用该功能拨打客服电话，联系客户。请您确认授权，否则无法使用该功能"},READ_EXTERNAL_STORAGE:{authorize:"android.permission.READ_EXTERNAL_STORAGE",title:"相册存储权限说明",describe:"便于您使用该功能上传您的照片、图片、视频，完善认证信息。请您确认授权，否则无法使用该功能"},CAMERA:{authorize:"android.permission.CAMERA",title:"相机权限说明",describe:"便于您使用该功能拍摄图片、录制视频，请您确认授权，否则无法使用该功能"},READ_EXTERNAL_STORAGE_CAMERA:{authorize:["android.permission.READ_EXTERNAL_STORAGE","android.permission.CAMERA"],title:"相册、相机权限说明",describe:"相册：便于您使用该功能上传您的照片、图片、视频，完善师傅认证信息。\n相机：便于您使用该功能拍摄图片、录制视频。\n请您确认授权，否则无法使用上述功能"}};return new Promise((o=>{"ios"!==plus.os.name.toLowerCase()?uni.getStorageSync(e)||!1?t?o():a(n[e].authorize,o):uni.showModal({title:n[e].title,content:n[e].describe,confirmText:"确定使用",success:r=>{if(r.confirm){if(uni.setStorageSync(e,!0),t)return void o();a(n[e].authorize,o)}else if(r.cancel){if(t)return;o(!1)}},fail:e=>{console.error(e)}}):o(!0)}))},l=e=>{const t={"android.permission.ACCESS_FINE_LOCATION":"获取定位权限失败，请手动打开授权或检查系统定位开关","android.permission.CALL_PHONE":"获取拨打电话权限失败，请手动打开授权","android.permission.READ_EXTERNAL_STORAGE":"获取相册权限失败，请手动打开授权","android.permission.CAMERA":"获取相机权限失败，请手动打开授权",[["android.permission.READ_EXTERNAL_STORAGE","android.permission.CAMERA"]]:"获取相机或相册权限失败，请手动打开授权"};uni.showModal({title:"权限提示",content:t[e],confirmText:"去设置",success:e=>{e.confirm&&uni.openAppAuthorizeSetting({success(e){console.log(e)}}),e.cancel}})},u=async({count:e=3,sizeType:t=["original","compressed"],sourceType:n=["album","camera"],success:r=o,fail:s=o,complete:i=o,...a})=>{let l=n.includes("album"),u=n.includes("camera"),f=!0;
// #endif
// #ifdef APP-PLUS
return l&&u?f=await c("READ_EXTERNAL_STORAGE_CAMERA"):u?f=await c("CAMERA"):l&&(f=await c("READ_EXTERNAL_STORAGE")),new Promise(((o,c)=>{f&&uni.chooseImage({count:e,sizeType:t,sourceType:n,...a,success(e){o(e),r(e)},fail(e){console.error("chooseImage",e),s(e),c(e)},complete(e){i(e)}})}))};return function(e){const t=e||uni;return{ylxEventBus:new s(t),ylxMustLogIn:new i(t),ylxNextPage:n,ylxChooseImage:u}}}));
